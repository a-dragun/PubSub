<h1>Chat Room: <%= room.name %></h1>

<h3>Users in this room:</h3>
<ul id="user-list">
</ul>

<ul id="messages"></ul>

<form id="chat-form">
  <input id="message-input" autocomplete="off" placeholder="Type a message..." />
  <button type="submit">Send</button>
</form>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  const roomId = "<%= room._id %>";
  const username = "<%= user.name %>";

  socket.emit('joinRoom', { roomId, username });

  socket.on('userListUpdated', (userList) => {
    const userListContainer = document.getElementById('user-list');
    userListContainer.innerHTML = '';

    userList.forEach((user) => {
      const li = document.createElement('li');
      li.textContent = `${user.name}: ${user.totalScore} bodova`;
      userListContainer.appendChild(li);
    });
  });

  const form = document.getElementById('chat-form');
  const input = document.getElementById('message-input');
  const messages = document.getElementById('messages');

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    const msg = input.value.trim();
    if (msg !== '') {
      socket.emit('chatMessage', { roomId, message: msg, username });
      input.value = '';
    }
  });

  socket.on('chatMessage', ({ username, message }) => {
  const li = document.createElement('li');
  li.innerHTML = `<strong>${username}:</strong> ${message}`;
  messages.appendChild(li);
  const img = li.querySelector('img');
  if (img) {
    img.onload = img.onerror = () => {
      messages.scrollTop = messages.scrollHeight;
    };
  } else {
    messages.scrollTop = messages.scrollHeight;
  }
});

socket.on('forceDisconnect', (data) => {
  alert(`You are sanctioned by admin. Reason: ${data.reason}`);
  socket.disconnect();
  window.location.href = '/';
});


</script>

<style>
    #messages {
      list-style: none;
      padding: 0;
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #ddd;
      margin-bottom: 10px;
      padding: 10px;
      background: #f9f9f9;
      white-space: pre;
    }
  
    #chat-form {
      display: flex;
      gap: 10px;
    }
  
    #message-input {
      flex: 1;
      padding: 8px;
    }
  
    button {
      padding: 8px 12px;
    }
</style>
  